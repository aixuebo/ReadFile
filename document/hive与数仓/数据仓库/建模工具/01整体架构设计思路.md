# 背景与总结
1.指标一致性如何解
指望模型绑定指标时候，判断指标是否一致，是有难度的，因为没办法确保所有的维度和指标的交叉都被校验通过。
所以解决方案是不通过校验的方式解决，而是通过创建的方式解决。
a.原子指标只能绑定在fact表上。并且只能绑定一次。
b.维度只能绑定在dim或者fact表上，并且只能绑定一次，最好是绑定在维度表上。
c.因为指标和维度都只绑定在一个表上，所以肯定确保了唯一性。
d.派生指标、计算指标都依赖于原子指标+维度派生而来，进而保障了全局的一致性。



# 系统架构
# 1.指标管理系统 
a.定义指标、维度：原子指标、派生指标、计算指标。
b.指标下游指标血缘依赖、指标在哪些数据模型存在(用于取数工具)、指标在哪些报表引用。

# 2.模型管理系统
a.绑定字段与维度/指标的映射关系。（注意：由于仅绑定原子指标、维度仅绑定一次，因此绑定的时候校验是否指标重复绑定很容易）。
b.维护好模型的基础信息，比如参考文档，业务过程、数仓分组、快照/增量表等信息。
c.实体建模，维护好模型之间的join关系
主键:用于实体建模，确保该id是全局唯一的主键，即商家id如果是主键，则说明该表有很多商家属性信息。
	主键表，说明是维度表，所以可以绑定维度信息。
唯一键：dt+id，确保分区内唯一。比如商家表的某一个子域，也是商家表，但id一定不能是主键，当标注好唯一键，说明他字段是表的唯一性；同时标注好改字段对应的维度，该维度应该最好仅是主键实体维度。
外键:用于关联，关联的也是实体主键。
分区日期格式


# 3.指标维度模型管理系统
a.丰富指标维度组合的能力
基于2绑定好的原子指标+维度，以及1定义的指标公式，以及实体建模的关系。
因此是可以left join 获取到唯一的计算公式的。此时应该不需要路由能力。

b.提供工具，用户拖拽指标维度，输入模型名字，创建一个指标维度模型，该模型用于C端用户查询路由逻辑，为查询加速。

c.系统判断指标维度的组合，是否已经存在了，避免不同RD创造相同的模型结果。

d.回刷机制
当指标公式发生变化的时候，难点在于如何回刷影响的模型。(优先级不高)

# 4.路由系统
a.基于"指标维度模型管理系统"，用户创建了很多维度指标的关系，此时意味着一个指标可以来自于多个模型，如何找到匹配最高效的表，就是路由系统最核心的算法。
b.我想到的策略
模型维度 > 用户查询的维度。
判断表大小，越小的表越应该被推荐。
如果候选集表中，维度数量差不多，应该考虑维度的枚举值数量，即维度数 * 维度枚举值数量 之和，决定了数据查询行数。越小越好。
统计模型表中数据行数，选择最优的表。


# 5.取数工具
a.权限鉴权
b.主题
把指标维度划分更小的子类。方便用户从更小的数据集合内取数。
注意：此时不要让RD输入需要从哪个模型查询，这样对系统有侵入性，日后系统很难改造。
而是应该完全相信路由系统能力，一定会最简化的找到对应的表。此时如果未来某一个中间模型下线，依然路由系统可以找到最匹配的表。
c.取数工具组合
只取原子指标+派生指标，计算指标不获取，而是对结果进一步计算而来，这样可以保障，计算指标的分子、分母可以来自于不同的模型，而不是一定来自于同一个模型。