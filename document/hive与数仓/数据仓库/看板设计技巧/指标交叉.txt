一、背景
看板需求中，经常有指标集合中，存在维度交叉情况，即当选择某一些维度的时候，指标是查不到内容的，因为指标没有跟该维度有矩阵交叉。

这种情况该如何设计数据模型呢?

二、案例case
1.维度:
商家粒度: 商家等级、商家城市。
交易粒度: 交易时段
商品粒度: 商品品类

2.指标:
订单交易额、订单量、dau、在售商家数、交易用户数。

3.分析
a.dau属于流量模块专属的指标。这个比较独立，很容易理解。
b.在售商家数，属于商家模块指标，也比较独立。

因此当选择维度是交易时段的时候，“在售商家数”这个指标应该不会产生数据，因为该之间跟时间段无关。
因此在设计上的时候，“在售商家数”指标在“交易时段”维度的默认值为-1，表示维度选择全部的时候才查询他。

c.订单交易额、订单量、商品订单量、交易用户数,在交易模块，也比较好统计。而且交易模块是有时间段的维度的。
所以这三个指标归属交易模块统计也是合理的。

d.非常重要的细节
如果订单有N个商品，因此有两个交易表：订单表、订单+商品表。
而这两个表都可以出，这个时候，原则是一个指标只能出自一个模块，该如何解决这个问题呢。

因为“订单交易额”肯定是订单表出，因为订单商品明细表的价格之和可能不等于订单总金额。
而交易用户数、订单量、商品订单量(当选择商品品类维度时)，这三个都是跟商品订单有关系，因为一个订单有N个商品，所以订单量需要count(distinct)。同时交易用户数也需要count(distinct)。

e.什么情况需要考虑count(distinct)。
当统计的信息，不能唯一归属某一个维度的时候，就需要考虑count(distinct)。
比如商家下单的用户，也可能去其他商家那下单，因此当统计城市维度下的 用户数的时候，就会重复，因此需要count(distinct)。
同样如果一个订单只能买一个商品，那订单数确实不需要count(distinct)。但大多数场景是一个订单有N个商品，因此订单数也需要count(distinct)。

三、设计方案
1.模型按照业务主题进行划分，指标只归属在某一个主题内。
2.采用union all的方式。查询所有的模型。
3.注意:所有模型要有共同的维度，如果没有维度的，使用默认值-1代替。

四、优化
因为没必要将所有的数据 union all组成一个结果，再在结果基础上查询。
可以利用工具化的方式，比如有5组数据集 union all的结果。可以分别查5个数据集的结果，将结果进行union all。

