
一、需求:商家明细看板
	可筛选的维度: 商家相关维度、商品品类、订单时段维度。
	指标:订单量、交易额、流量pv
	
二、查询场景:
筛选xx城市，三级品类商品，完成订单量。
筛选xx城市，三级品类商品，午餐时段，完成订单量。

三、遇到的问题:
a.商品品类、订单时段 属于订单维度覆盖，而不是商家维度独有属性。
因此当选择这两个维度时，会有一些指标，比如流量pv无数据，显示null。
同时跨模型引入维度，即引入的维度不是商家模型的专属维度，会造成商品明细模型不可用。

b.该实现需要的是一个交易表的多维汇总模型表。
即商家id、spuid、时段组合做维度 + 汇总结果表。
应用时，使用多维汇总表+维度表产生所有数据。

c.下单时段因为只有5个枚举值，能否拆成5个指标，从而不开发这个维度呢？即下单时段为什么不能把时间段打散到指标里，而一定要放在维度里。
不可以。
原因是 不止有完成订单量，还有很多个指标，那也就意味着所有指标都要扩展好多倍，运维成本太高。

d.这种报表会很难理解，因为指标与维度不能对齐，有一些场景查询结果是指标为null(即不该有指标出现)
假设一共有100个指标，其中80个跟订单有关系，20个无关系。
因为增加了订单维度，导致当查询该维度时，会有20个指标显示null，新同学会觉得查询是不是出错了，理解成本太高。

四、解决方案
那正确的产品设计方案是什么？
正确的设计方案是，指标维度要对齐，比如这种查询场景，应该是多维汇总表看板支持。

原则是 按照指标拆分“多维汇总”看板，比如交易看板，展示都是跟交易有关系的多维汇总维度筛选器。

五、解决方案case
1.指标、维度背景说明
3个不同方向的维度: 商家等级、订单时段、商品品类，即分别来自于商家、订单、商品。
指标:订单量、在售商家数

2."订单量"指标如何设计
订单量指标可以按照商家聚合，是理想的方式，但这样只能支撑商家维度的统计，当选择某一个品类的订单量时，无法支持；同时筛选某一个时间段的订单量也没有办法支持；

因此订单量的最小粒度是: 时段+spu_id。
注意:选择spu_id而不是选择品类,是为了更好的扩展性，明细表要兼容未来扩展性，不怕太细。品类需求可以从该明细表继续汇总即可。

因此结论:
维度粒度:订单粒度 --> 时间段+spu_id --> 时间段 + 商品品类 + 商家id维度。 
指标值:1
指标函数是sum。

3."在售商家数"指标如何设计
筛选案例
筛选品类，获取该品类上，再售商家数。 ---> 说明粒度是spu_id。
筛选时段+品类,则输出 null。因为默认时段为-1即可。


因此结论:
维度粒度:spu粒度 --> 时间段选择默认值-1 + spu_id --> 时间段 + 商品品类 + 商家id维度。 
指标值:商家id。
指标函数是count(distinct())

六、优化方案
1.经过五的case，我们知道最终结果的条数是 订单明细数量 + 商品明细数量。
其中有很多是null，甚至可以再聚合的。

2.每一个模块 根据 所有维度，在聚合一下。
指标聚合规则:
当遇到count(distinct())，则直接转换成min
当遇到sum,则直接sum即可。

比如同一个商家的多个商品，他们可能共同的品类信息，因此他们的在售商家数应该count(distinct())，结果都是1，因此可以预聚合成一条数据。
即同商家 + 品类id --> 在售商家id作为值。

因此 结果数量 由 订单明细数量 + 商品明细数量 --> 订单明细数量 + 商家品类明细数量。

3.cube 将结果输出。