# 一、背景与总结
## 1.名词
面相以下建模：业务主题(交易)、业务过程(活动+订单)、分析对象(交易商家)、分析对象建模。
## 2.每层内容
fact:清洗 + 虚拟列的方式定义原子指标(即维度动作+度量都要在fact表里存在)。
aggr:面向业务对象建模 -- 主键+业务主题+业务对象+维度+原子指标的聚合汇总。
topic:面向分析对象建模+数据应用建模。
## 3.开发细节
* 主键要在DDL上做标注，指标用sum、distinct标注清晰。
* 经常不变的指标放到CDL层做汇总；经常变的指标、探索的指标，放到CDL层价值不大，可以考虑放到app或者dim层，随时释放掉。
* CDL层尽量不要冗余其他分析对象的维度属性，这样不方便扩展，影响回刷数据。
* CDL拆分表很多，所以CDL不会是一个宽表；下游也不会很多任务，主要对接topic，由topic对接很多下游任务。

## 4.指标的定义,尤其原子指标
用户在操作了哪些动作，产生了该指标。

## 5.定义好表格，存储每一个表，层级规范如下:
aggr层:业务主题、分析对象、模型拆分原则(参考4.6节)。



# 二、数仓整体架构
## 2.1 ODS层(A origin)
1.解决什么问题：数据源统一接入。
2.核心产出:增量接入表、全量接入表、全量快照表(每天一个全量快照)

## 2.2 IDL层(B3 fact 数据集成层)
1.解决什么问题：屏蔽底层影响，还原业务，统一标准。即定义好维度动作+度量。
2.核心动作:业务主题划分、数据规范化清洗
3.核心产出:快照表。
4.举例: 订单表。
5.注意事项:

## 2.3 CDL层(B2 aggr 数据组件层component)
1.解决什么问题：指标口径统一，避免重复计算。即原子指标的聚合收口 + 派生维度的标准化定义。
2.核心动作:业务实体识别,分析主题划分
3.核心产出:快照表 && 生产环境需要的表。
4.举例: 交易商家表。
5.注意事项:
* 需要严格参与回刷。
* 用户数仓生产任务、数仓产品化任务血缘依赖。


## 2.4 MDL层(B1 topic 数据集市层)
1.解决什么问题：数据分析查询，数据应用支持。
2.核心动作:宽表模型、汇总模型。
3.核心产出:大宽表，或者view视图
4.举例: 各种商家宽表,商家+时段宽表等。
5.注意事项:

## 2.5 ADL层(C app 数据应用层)
1.解决什么问题：多维数据分析，应用模型、多维分析
2.核心动作:
很薄的一层,做left join的数据拼接工作；
甚至用view解决数据频繁变化,导致的回刷问题；
不常用的指标建设。
3.核心产出:直接对接业务需求，当判断是否回刷时,仅针对app层进行判断是否回刷即可。
4.举例: 满足各个需求的app。
5.注意事项:

## 2.6 DIM层
1.解决什么问题：维度属性的统一。
2.开发原则
* Dim表存储枚举值信息。
* DIM表存储有唯一主键的信息，并且大多是静态属性，不允许存放动态汇总的原子指标结果。
* Dim表更多是标签，比如区间、城市等级等信息的定义。
* 维度是否可以认为是一个分析对象，如果是，则不用创建dim表。比如poi不需要维度，就在CDL层做即可。因为分析对象带来的复用性和价值会更高。

# 三、IDL层建模原则
## 1.总结
有主键、明确业务主题、分析对象(或者业务过程)、维度、维度属性。
用虚拟列的方式定义原子指标。
数据清洗，增加where条件删除无效数据；从json提取常用有效字段信息。

# 四、CDL层建模原则
## 1.总结
有主键、明确业务主题、分析对象(或者业务过程)、维度、维度属性、原子指标汇总结果
## 2.建模四步原则
* 确认业务主题(订单、商家等)和分析对象(业务实体或者业务活动过程)：分析对象明确了,就明确了PK粒度(比如商家、用户)
* 确认主键：必须有PK主键
* 确认维度:分析对象相关的事实、维度字段关联维度码表，形成静态多维模型。(维度属性、维度)
* 确认指标:分析对象粒度的业务过程事实行为汇总，形成指标(动态指标集)
大多是原子指标的标准化过程，指标相对问题(因为原子指标 = 动作+度量)，度量就是订单量等事实字段，所以肯定是稳定的指标。即对稳定的原子指标字段进行聚合。

注意：
CDL层尽量不要冗余其他分析对象的维度属性，这样不方便扩展，影响回刷数据。

## 3.CDL为什么是组件建模
* 业务变化仅会影响一部分组件，因此下游topic等 与 业务变化会解耦，在aggr层做隔离。
* CDL层分静态多维表 + 动态指标表，也是为了解耦。毕竟指标变化会更频繁一些；基础指标也不是天天变化。

## 4.怎么看待分析对象这个概念
* 不同业务看的分析对象视角不同，比如代理、直营看的可能是不一样的属性，所以有必要拆成两个分析对象。
再比如非连锁商家、连锁商家。而且伴随着业务的逐渐复杂，比如业务上连锁商家做的越来越重，也越来越有价值，因此需要更细粒度的连锁商家 业务对象被拆分。
* 基建建设是相对业务滞后的，沉淀哪些变化与不变的，有一定滞后性，但当下游业务重复频率很高时，就应该沉淀到基建了。

## 5.分析对象应该有哪些静态维度、动态指标集
* 静态维度集合：分析对象本应该有的业务维度属性 + 通过其他维度表扩展的 + 脑暴两个分析对象之间是否有关系抽象出维度,进而进行扩展，比如商家和商家之间的商圈关系。
* 动态指标集: 一定是大多数不可变化的原子指标集合 + 稳定的派生指标。其实是可以脑暴出来的，因为维度是明确的，度量也是明确的，剩下的就是维度枚举值+度量的排列组合了。

## 6.模型拆分原则：CDL层一个明确的业务分析对象，需要有几个模型承接
虽然从维度建模的视角看，相同维度的指标放在一起，但不能照本宣科。一个特别大的宽表在aggr层，会带来扩展性的风险 以及 上游的业务变更会导致所有的下游都受影响，
因为下游依赖的太宽了。而生产模型和数据产品应该尽量减少依赖宽表。
* 静态维度模型。
* 动态原子指标集。
* 动态最近30天指标集。
* 动态稳定的派生指标集合。
* 指标的其他拆分方式的考虑因素:
	就绪时间早晚
	日/多日，比如7d、30d
	业务线特殊性
	指标的稳定与多变性
	上游的稳定性
	查询热度
	是否向前追溯N天，比如结算和订单不是一个生产调度周期
	业务系统来源视角(商家交易指标和商家流量指标，当然看成就绪时间的不同也是可以的)
	时间周期(日周月)
	历史累计成单指标、首购指标
	刷数成本(是否变化、考虑模型复杂度、计算消耗成本高)。
* 维度的其他拆分方式的考虑因素:
	包含指标因素
	描述类维度或者url(非常长,用的少，单独拆开)。
	刷数成本(是否变化、考虑模型复杂度、计算消耗成本高)。
	全量还是快照维度表。


# 五、有挑战的问题
1.最近30天订单量这种指标，应该在aggr层、topic、DIM哪层出
* 我推荐在dim或者aggr层出，因为可以被topic、app都可以使用。所以肯定不在topic出。
* 我更推荐在aggr出,因为dim不应该做指标的聚合汇总。

2.CDL层的分析对象有静态多维的维度属性，dim也有维度属性，那是aggr依赖dim获取维度属性吗？以及dim_poi与aggr_poi在维度属性上是否重复定义，用户视角用哪个更合适？
此时不要有dim表，直接CDL层定义即可，因为分析对象带来的复用性和价值会更高。
原子是：分析对象明确了，又是核心的分析对象，因此就没必要在为核心的分析对象创建额外的dim表了，直接在分析对象上创建静态维度即可。

3.CDL层建议使用view吗
不建议，容易造成view 嵌套view的情况，因为CDL层太底层了。此时view 套 view会性能很差。

4.CDL层创建了那么多的表，下游和用户如何使用CDL层呢？
* 尽量CDL层是面向生产环境 + 数据产品的，所以尽量不对外开放，除非特别简单并且未来很少变更的业务 同时下游又很少被用到，可以让下游用CDL层。
* 下游主要用CDL进行join拼接的topic层。
* 针对部分数据产品经常用到的指标和维度，创建两个CDL层表，用于收口数据产品的指标和维度。但仅数仓生产用，下游依然用对应的topic_view表。因此理论上口径的变更不用通知下游参与回刷，只是数据产品内部回刷即可。

5.分析对象，核心的对象，会字段越来越多，下游也会很多，如何考虑扩展性。
本质上是错误的，CDL层的分析对象要拆分足够细，所以他不会有很多字段。并且下游也不会很多，CDL的下游主要是topic。
而topic的下游才是面向查询分析的，所以他的下游很多，但由于与数仓生产无关，即数仓不会依赖，因此扩展字段不影响数仓，并且回刷成本低(都是基于aggr物化好的表)。

6.派生指标应该在哪层定义。
* 理论上topic层收口
因为CDL层是有主键的，并且没有冗余其他业务对象的维度属性，而派生指标大多数是跨主题的，比如交易指标要依赖商家属性+订单指标。
所以CDL没办法跨主题，也就不适合做派生指标收口。所以topic更合适。
* 推荐用aggr层收口
但由于生产+数据产品依赖CDL层，所以我们建议还是在CDL层做一些特殊的CDL模型，代替topic模型，只是视角是数仓内部生产用。所以收口指标在该CDL层也是合理的。
* 有例子吗
真实的CDL反应事实数据，所以是原子的，不会因为业务的口径，导致他的口径变化。所以CDL沉淀的是事实数据。
比如价格带,他不好管控,明天可能会价格带的阈值会变化,所以实付交易额的价格可以沉淀下来.但价格带不应该放在CDL，而是放在topic或者aggr生产收口层。
* 所以CDL层数据表数量不会泛滥，topic层才会泛滥，但topic是面向用户的，CDL是面向生产的。

7.多维模型、动态指标集的命名方式？
agar_poi_status_d 多维属性
aggr_poi_ord_trade_d 商家交易指标
aggr_poi_flow_d 商家流量指标

topic用info,因为既包含静态多维，又包含动态指标。
